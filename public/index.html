<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Devil Troll Multiplayer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #222; overflow: hidden; }
        #controls { position: fixed; bottom: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; z-index: 100; pointer-events: none; }
        .btn { width: 80px; height: 80px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; border: 2px solid white; color: white; font-size: 24px; pointer-events: auto; touch-action: manipulation; }
        .btn:active { background: rgba(255, 255, 255, 0.5); }
    </style>
</head>
<body>

<div id="controls">
    <div>
        <button class="btn" id="left">‚¨ÖÔ∏è</button>
        <button class="btn" id="right">‚û°Ô∏è</button>
    </div>
    <button class="btn" id="jump">ü¶ò</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // --- LEVELLAR BAZASI (XARITALAR) ---
    // # = Devor, ^ = Tikan, @ = Start, ! = Eshik (Win), * = Arra, _ = Yiqiladigan pol
    const levels = [
        // Level 1: Oson boshlanish
        [
            "####################",
            "#                  #",
            "# @                #",
            "#####   #######    #",
            "#       #     #  ! #",
            "#       #     ######",
            "#  ^^^  #          #",
            "####################"
        ],
        // Level 2: "Devil" Tuzoqlar
        [
            "####################",
            "# !                #",
            "#####         #    #",
            "#      * #    #",
            "#    ####     #    #",
            "# @  #  #   ^^#    #",
            "######  ########## #",
            "####################"
        ],
        // Level 3: Parkour
        [
            "####################",
            "#                  #",
            "#  @      _     !  #",
            "# ###    ###   ### #",
            "#      * #",
            "# ^^^^^^^^^^^^^^^^ #",
            "####################",
            "####################"
        ]
    ];

    const TILE_SIZE = 40; // Har bir blok o'lchami

    const config = {
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: window.innerHeight,
        backgroundColor: '#4a1c1c',
        physics: {
            default: 'arcade',
            arcade: { gravity: { y: 800 }, debug: false }
        },
        scene: { preload, create, update }
    };

    const game = new Phaser.Game(config);
    let socket, player, cursors;
    let otherPlayers, platforms, spikes, door, saws, fakeFloors;
    let isLeft = false, isRight = false, isJump = false;
    let myId;

    function preload() {
        // Rasmlar o'rniga rangli shakllar yasaymiz (internet kerak emas)
        let graphics = this.make.graphics({x: 0, y: 0, add: false});
        
        // Devor
        graphics.fillStyle(0x000000);
        graphics.fillRect(0, 0, 40, 40);
        graphics.generateTexture('wall', 40, 40);
        
        // Tikan (Spike)
        graphics.clear();
        graphics.fillStyle(0xff0000);
        graphics.beginPath();
        graphics.moveTo(0, 40); graphics.lineTo(20, 0); graphics.lineTo(40, 40);
        graphics.fillPath();
        graphics.generateTexture('spike', 40, 40);

        // Player (Oq kvadrat)
        graphics.clear();
        graphics.fillStyle(0xffffff);
        graphics.fillRect(0, 0, 30, 30);
        graphics.generateTexture('player', 30, 30);

        // Eshik
        graphics.clear();
        graphics.fillStyle(0x00ff00);
        graphics.fillRect(0, 0, 40, 60);
        graphics.generateTexture('door', 40, 60);

        // Arra (Saw)
        graphics.clear();
        graphics.fillStyle(0xcccccc);
        graphics.fillCircle(20, 20, 20);
        graphics.generateTexture('saw', 40, 40);
    }

    function create() {
        socket = io();
        otherPlayers = this.physics.add.group();
        
        // Guruhlar
        platforms = this.physics.add.staticGroup();
        spikes = this.physics.add.staticGroup();
        saws = this.physics.add.group(); // Dinamik guruh (harakatlanadi)
        fakeFloors = this.physics.add.staticGroup();

        // Serverdan ma'lumot kutish
        socket.on('initGame', (data) => {
            myId = socket.id;
            buildLevel(this, data.levelIndex);
            
            Object.keys(data.players).forEach((id) => {
                if (id !== myId) addOtherPlayer(this, data.players[id]);
            });
            
            // O'zimni yaratish
            if (!player) createPlayer(this, data.players[myId]);
        });

        socket.on('newPlayer', (pInfo) => addOtherPlayer(this, pInfo));
        
        socket.on('playerMoved', (pInfo) => {
            otherPlayers.getChildren().forEach((other) => {
                if (pInfo.playerId === other.playerId) other.setPosition(pInfo.x, pInfo.y);
            });
        });

        socket.on('playerDisconnected', (id) => {
            otherPlayers.getChildren().forEach((other) => {
                if (id === other.playerId) other.destroy();
            });
        });

        socket.on('changeLevel', (index) => {
            restartGame(this, index);
        });

        // Boshqaruv
        cursors = this.input.keyboard.createCursorKeys();
        setupTouchControls();
    }

    function update() {
        if (player) {
            if (cursors.left.isDown || isLeft) player.setVelocityX(-200);
            else if (cursors.right.isDown || isRight) player.setVelocityX(200);
            else player.setVelocityX(0);

            if ((cursors.up.isDown || isJump) && player.body.touching.down) {
                player.setVelocityY(-550);
            }

            // Arra aylanishi
            saws.getChildren().forEach(saw => {
                saw.rotation += 0.1;
            });

            // Yiqilib tushsa
            if (player.y > window.innerHeight + 100) respawn();

            // Serverga pozitsiya
            let x = player.x; let y = player.y;
            if (player.oldPos && (x !== player.oldPos.x || y !== player.oldPos.y)) {
                socket.emit('playerMovement', { x, y });
            }
            player.oldPos = { x, y };
        }
    }

    function buildLevel(scene, index) {
        // Tozalash
        platforms.clear(true, true);
        spikes.clear(true, true);
        saws.clear(true, true);
        fakeFloors.clear(true, true);
        if (door) door.destroy();

        const map = levels[index];
        let startX = 100, startY = 100;

        for (let y = 0; y < map.length; y++) {
            for (let x = 0; x < map[y].length; x++) {
                let tile = map[y][x];
                let posX = x * TILE_SIZE + 20;
                let posY = y * TILE_SIZE + 20;

                if (tile === '#') platforms.create(posX, posY, 'wall');
                else if (tile === '^') spikes.create(posX, posY, 'spike');
                else if (tile === '@') { startX = posX; startY = posY; }
                else if (tile === '!') door = scene.physics.add.staticSprite(posX, posY, 'door');
                else if (tile === '_') {
                    let floor = fakeFloors.create(posX, posY, 'wall');
                    floor.setTint(0x888888); // Sal boshqacha rang
                }
                else if (tile === '*') {
                    let saw = saws.create(posX, posY, 'saw');
                    saw.body.allowGravity = false;
                    saw.setImmovable(true);
                    // Arra harakati (Tween)
                    scene.tweens.add({
                        targets: saw,
                        x: posX + 100,
                        duration: 1500,
                        yoyo: true,
                        repeat: -1
                    });
                }
            }
        }
        return { x: startX, y: startY };
    }

    function createPlayer(scene, info) {
        player = scene.physics.add.sprite(info.x, info.y, 'player');
        player.setTint(info.color);
        player.setBounce(0.1);
        player.setCollideWorldBounds(false); // Pastga tushib ketishi uchun

        scene.physics.add.collider(player, platforms);
        
        // Tikan va Arra o'ldiradi
        scene.physics.add.collider(player, spikes, respawn, null, scene);
        scene.physics.add.overlap(player, saws, respawn, null, scene);

        // Yiqiladigan pol
        scene.physics.add.collider(player, fakeFloors, (p, f) => {
            scene.time.delayedCall(500, () => { f.body.enable = false; f.visible = false; }); // 0.5 sekdan keyin yo'qoladi
        }, null, scene);

        // Eshik (Yutish)
        scene.physics.add.overlap(player, door, () => {
            socket.emit('levelWin');
        }, null, scene);
    }

    function addOtherPlayer(scene, info) {
        let other = scene.physics.add.sprite(info.x, info.y, 'player');
        other.setTint(info.color);
        other.playerId = info.playerId;
        other.body.allowGravity = false; // Boshqalarga fizika shart emas
        otherPlayers.add(other);
    }

    function respawn() {
        player.setVelocity(0, 0);
        player.setPosition(100, 200); // Start joyiga qaytish
        tg.HapticFeedback.notificationOccurred('error');
    }

    function restartGame(scene, index) {
        if (player) {
            player.setVelocity(0, 0);
            player.setPosition(100, 200);
        }
        buildLevel(scene, index);
        tg.HapticFeedback.notificationOccurred('success');
    }

    function setupTouchControls() {
        document.getElementById('left').addEventListener('touchstart', (e) => { e.preventDefault(); isLeft = true; });
        document.getElementById('left').addEventListener('touchend', (e) => { e.preventDefault(); isLeft = false; });
        document.getElementById('right').addEventListener('touchstart', (e) => { e.preventDefault(); isRight = true; });
        document.getElementById('right').addEventListener('touchend', (e) => { e.preventDefault(); isRight = false; });
        document.getElementById('jump').addEventListener('touchstart', (e) => { e.preventDefault(); isJump = true; });
        document.getElementById('jump').addEventListener('touchend', (e) => { e.preventDefault(); isJump = false; });
    }
</script>
</body>
</html>